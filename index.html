<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora ITP Catalunya 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f2f0;
      color: #1c211f;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: #f5f2f0;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h2 {
      text-align: center;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 1em;
      border-radius: 5px;
      box-sizing: border-box;
    }
    input[type="number"], input[type="text"], input[type="email"] {
      border: 1px solid #ccc;
      background: #fff;
      color: #1c211f;
    }
    button {
      background-color: #6d827f;
      color: white;
      border: none;
      cursor: pointer;
    }
    #resultado {
      margin-top: 15px;
      padding: 15px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #formularioPDF {
      display: none;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Calculadora ITP Catalunya 2025</h2>
    <label for="precio">Introduce el precio de compra:</label>
    <input type="number" id="precio" placeholder="Ejemplo: 300000">
    <button onclick="calcularITP()">Calcular ITP</button>

    <div id="resultado"></div>

    <div id="formularioPDF">
      <h3>Descargar informe PDF</h3>
      <form id="itpForm" action="https://formspree.io/f/xkgbnbev" method="POST">
        <input type="text" name="nombre" id="nombre" placeholder="Tu nombre" required>
        <input type="email" name="email" id="email" placeholder="Tu email" required>
        <input type="text" name="telefono" id="telefono" placeholder="Tu teléfono" required>
        <button type="submit">Enviar y descargar PDF</button>
      </form>
    </div>
  </div>

  <script>
    let resumenTexto = "";

    function calcularITP() {
      const precio = parseFloat(document.getElementById("precio").value);
      let impuesto = 0;

      if (isNaN(precio) || precio <= 0) {
        document.getElementById("resultado").innerText = "Por favor, introduce un número válido.";
        return;
      }

      const tramos = [
        { limite: 600000, tipo: 0.10 },
        { limite: 900000, tipo: 0.11 },
        { limite: 1500000, tipo: 0.12 },
        { limite: Infinity, tipo: 0.13 }
      ];

      let restante = precio;
      let anteriorLimite = 0;
      let detalles = "";

      for (let tramo of tramos) {
        if (precio > anteriorLimite) {
          const base = Math.min(restante, tramo.limite - anteriorLimite);
          const impTramo = base * tramo.tipo;
          impuesto += impTramo;
          detalles += `• ${base.toLocaleString('es-ES')} € al ${(tramo.tipo*100).toFixed(0)}% = ${impTramo.toLocaleString('es-ES',{style:'currency',currency:'EUR'})}\n`;
          restante -= base;
          anteriorLimite = tramo.limite;
        }
      }

      const tipoEfectivo = (impuesto / precio * 100).toFixed(2);

      resumenTexto = `Precio de compra: ${precio.toLocaleString('es-ES',{style:'currency',currency:'EUR'})}\n` +
                     `ITP total: ${impuesto.toLocaleString('es-ES',{style:'currency',currency:'EUR'})}\n` +
                     `Tipo efectivo: ${tipoEfectivo}%\n\n` +
                     `Detalle por tramos:\n${detalles}`;

      document.getElementById("resultado").innerHTML = resumenTexto.replaceAll('\n', '<br>') +
        "<br><em>Tramos informativos:</em><br>• Hasta 600.000 € → 10%<br>• 600.001 - 900.000 € → 11%<br>• 900.001 - 1.500.000 € → 12%<br>• Más de 1.500.000 € → 13%";

      document.getElementById("formularioPDF").style.display = "block";
    }

    async function handleFormSubmit(event) {
      event.preventDefault();
      console.log("Enviando formulario...");

      const form = event.target;
      const formData = new FormData(form);

      const nombre = formData.get("nombre");
      const email = formData.get("email");
      const telefono = formData.get("telefono");

      const response = await fetch(form.action, {
        method: form.method,
        body: formData,
        headers: { 'Accept': 'application/json' }
      });

      if (response.ok) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text(`Informe personalizado para: ${nombre}`, 10, 10);
        doc.text(`Email: ${email}`, 10, 20);
        doc.text(`Teléfono: ${telefono}`, 10, 30);
        doc.text("", 10, 40);
        doc.text(resumenTexto, 10, 50);

        doc.save("informe-itp.pdf");
        form.reset();
      } else {
        alert("Hubo un error al enviar el formulario.");
      }

      return false;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("itpForm");
      form.addEventListener("submit", handleFormSubmit);
    });
  </script>
</body>
</html>